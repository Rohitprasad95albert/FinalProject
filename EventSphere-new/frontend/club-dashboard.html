<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <title>Club Dashboard - EventSphere</title>
    <meta name="viewport" content="width=device-width, initial-scale=1">
    <script src="https://cdn.tailwindcss.com"></script>
    <script>
        tailwind.config = { theme: { extend: { colors: { primary:'#2563EB', secondary:'#FACC15', accent:'#22C55E', background:'#F9FAFB', text:'#111827' }, animation:{'fade-in':'fadeIn .6s ease-in-out','slide-up':'slideUp .5s ease-out'}, keyframes:{ fadeIn:{'0%':{opacity:'0'},'100%':{opacity:'1'}}, slideUp:{'0%':{transform:'translateY(20px)',opacity:'0'},'100%':{transform:'translateY(0)',opacity:'1'}} } } } };
    </script>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.10.0/font/bootstrap-icons.css" rel="stylesheet">
    <style>
        .gradient-text{background:linear-gradient(135deg,#2563EB 0%,#22C55E 100%);-webkit-background-clip:text;-webkit-text-fill-color:transparent;background-clip:text}
        .gradient-bg{background:linear-gradient(135deg,#2563EB 0%,#22C55E 100%)}
        .glass-effect{backdrop-filter:blur(10px);background:rgba(255,255,255,.9)}
        .card-hover{transition:all .3s ease}
        .card-hover:hover{transform:translateY(-5px);box-shadow:0 20px 25px -5px rgba(0,0,0,.1),0 10px 10px -5px rgba(0,0,0,.04)}
    </style>
</head>
<body class="bg-background text-text min-h-screen">
    <nav id="navbar-container" class="fixed top-0 w-full z-50 glass-effect border-b border-gray-200"></nav>

    <main class="pt-24 pb-16 px-4 sm:px-6 lg:px-8">
        <div class="max-w-7xl mx-auto">
            <div class="mb-6 animate-fade-in">
                <h1 class="text-3xl sm:text-4xl font-bold gradient-text">Club Dashboard</h1>
                <p class="text-gray-600 mt-2">Create events, manage attendees, and upload certificates</p>
            </div>

            <section class="bg-white rounded-2xl shadow-lg p-6 card-hover animate-slide-up">
                <h3 class="text-xl font-bold mb-4">Create New Event</h3>
                <form id="event-form" class="space-y-6">
                    <div class="grid grid-cols-1 md:grid-cols-2 gap-6">
                        <div>
                            <label class="block text-sm font-semibold text-gray-700 mb-2">Event Title</label>
                            <input type="text" id="title" name="title" class="w-full px-4 py-3 border border-gray-300 rounded-xl focus:ring-2 focus:ring-primary focus:border-transparent" required />
                        </div>
                        <div>
                            <label class="block text-sm font-semibold text-gray-700 mb-2">Event Poster</label>
                            <input type="file" id="poster" name="poster" accept="image/*" class="w-full px-4 py-3 border border-gray-300 rounded-xl" required />
                        </div>
                    </div>
                    <div>
                        <label class="block text-sm font-semibold text-gray-700 mb-2">Description</label>
                        <textarea id="description" name="description" rows="3" class="w-full px-4 py-3 border border-gray-300 rounded-xl focus:ring-2 focus:ring-primary focus:border-transparent" required></textarea>
                    </div>
                    <div class="grid grid-cols-1 md:grid-cols-3 gap-6">
                        <div>
                            <label class="block text-sm font-semibold text-gray-700 mb-2">Date</label>
                            <input type="date" id="date" name="date" class="w-full px-4 py-3 border border-gray-300 rounded-xl" required />
                        </div>
                        <div>
                            <label class="block text-sm font-semibold text-gray-700 mb-2">Time</label>
                            <input type="time" id="time" name="time" class="w-full px-4 py-3 border border-gray-300 rounded-xl" required />
                        </div>
                        <div>
                            <label class="block text-sm font-semibold text-gray-700 mb-2">Venue</label>
                            <input type="text" id="venue" name="venue" class="w-full px-4 py-3 border border-gray-300 rounded-xl" required />
                        </div>
                    </div>
                    <div class="grid grid-cols-1 md:grid-cols-3 gap-6">
                        <div>
                            <label class="block text-sm font-semibold text-gray-700 mb-2">Event Category</label>
                            <select id="type" name="type" class="w-full px-4 py-3 border border-gray-300 rounded-xl">
                                <option>Tech</option><option>Cultural</option><option>Sports</option><option>Workshop</option><option>Seminar</option><option>Other</option>
                            </select>
                        </div>
                        <div>
                            <label class="block text-sm font-semibold text-gray-700 mb-2">Competition Type</label>
                            <select id="competitionType" name="competitionType" class="w-full px-4 py-3 border border-gray-300 rounded-xl">
                                <option>Intra College</option><option>Inter College</option>
                            </select>
                        </div>
                        <div>
                            <label class="block text-sm font-semibold text-gray-700 mb-2">Mode</label>
                            <select id="eventMode" name="eventMode" class="w-full px-4 py-3 border border-gray-300 rounded-xl" onchange="toggleMeetingLink()">
                                <option>Offline</option><option>Online</option>
                            </select>
                        </div>
                    </div>
                    <div id="meetingLink-group" class="hidden">
                        <label class="block text-sm font-semibold text-gray-700 mb-2">Meeting Link</label>
                        <input type="url" id="meetingLink" name="meetingLink" class="w-full px-4 py-3 border border-gray-300 rounded-xl" />
                    </div>
                    <div class="grid grid-cols-1 md:grid-cols-2 gap-6">
                        <div>
                            <label class="block text-sm font-semibold text-gray-700 mb-2">Registration Fee (₹0 for free)</label>
                            <input type="number" id="registrationFee" name="registrationFee" value="0" min="0" class="w-full px-4 py-3 border border-gray-300 rounded-xl" />
                        </div>
                        <div>
                            <label class="block text-sm font-semibold text-gray-700 mb-2">Registration Limit (0 for unlimited)</label>
                            <input type="number" id="registrationLimit" name="registrationLimit" value="0" min="0" class="w-full px-4 py-3 border border-gray-300 rounded-xl" />
                        </div>
                    </div>
                    <h4 class="text-lg font-semibold">Attendance Verification Question (Optional)</h4>
                    <div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-3">
                        <input type="text" id="question" name="question" placeholder="Question" class="px-4 py-3 border border-gray-300 rounded-xl">
                        <input type="text" id="option1" name="option1" placeholder="Option 1" class="px-4 py-3 border border-gray-300 rounded-xl">
                        <input type="text" id="option2" name="option2" placeholder="Option 2" class="px-4 py-3 border border-gray-300 rounded-xl">
                        <input type="text" id="option3" name="option3" placeholder="Option 3" class="px-4 py-3 border border-gray-300 rounded-xl">
                        <input type="text" id="option4" name="option4" placeholder="Option 4" class="px-4 py-3 border border-gray-300 rounded-xl">
                        <input type="text" id="correctAnswer" name="correctAnswer" placeholder="Correct Answer (must match one option)" class="px-4 py-3 border border-gray-300 rounded-xl">
                    </div>
                    <button type="submit" class="gradient-bg text-white px-6 py-3 rounded-xl font-semibold hover:shadow-lg transition-all duration-300 transform hover:scale-105">Submit for Approval</button>
                    <p id="proposal-msg" class="mt-2 hidden"></p>
                </form>
            </section>

            <section class="bg-white rounded-2xl shadow-lg p-6 card-hover animate-slide-up mt-8">
                <h3 class="text-xl font-bold mb-2">Certificate Management</h3>
                <p class="text-gray-600 mb-4">Upload a custom PDF certificate template for one of your approved events.</p>
                <form id="certificate-upload-form" class="space-y-4">
                    <div>
                        <label class="block text-sm font-semibold text-gray-700 mb-2">Select an Approved Event</label>
                        <select id="event-select" class="w-full px-4 py-3 border border-gray-300 rounded-xl" required>
                            <option value="">Loading...</option>
                        </select>
                    </div>
                    <div>
                        <label class="block text-sm font-semibold text-gray-700 mb-2">Certificate Template (PDF only)</label>
                        <input type="file" id="certificate-file" accept=".pdf" class="w-full px-4 py-3 border border-gray-300 rounded-xl" required />
                    </div>
                    <button type="submit" class="px-6 py-3 rounded-xl font-semibold text-white" style="background:#06b6d4">Upload Template</button>
                    <p id="cert-upload-msg" class="mt-2 hidden"></p>
                </form>
            </section>

            <section class="mt-8 animate-slide-up">
                <h3 class="text-2xl font-bold mb-4">Your Submitted Events</h3>
                <div id="pending-events-container" class="mb-6"></div>
                <div id="approved-events-container"></div>
            </section>
        </div>
    </main>

    <!-- Modals -->
    <div id="attendanceModal" class="fixed inset-0 bg-black bg-opacity-50 hidden items-center justify-center z-50">
        <div class="bg-white rounded-2xl shadow-xl p-6 max-w-2xl w-full mx-4">
            <div class="flex items-center justify-between mb-4">
                <h5 class="text-xl font-bold">Attendees for <span id="modal-event-title"></span></h5>
                <button type="button" class="text-gray-400 hover:text-gray-600" onclick="document.getElementById('attendanceModal').classList.add('hidden')"><i class="bi bi-x-lg"></i></button>
            </div>
            <div id="attendees-list"></div>
        </div>
    </div>
    <div id="qrCodeModal" class="fixed inset-0 bg-black bg-opacity-50 hidden items-center justify-center z-50">
        <div class="bg-white rounded-2xl shadow-xl p-6 max-w-md w-full mx-4">
            <div class="flex items-center justify-between mb-4">
                <h5 class="text-xl font-bold">QR Code</h5>
                <button type="button" class="text-gray-400 hover:text-gray-600" onclick="document.getElementById('qrCodeModal').classList.add('hidden')"><i class="bi bi-x-lg"></i></button>
            </div>
            <div id="qrcode" class="flex justify-center"></div>
        </div>
    </div>

    <script src="qrcode.min.js"></script>
    <script src="config.js"></script>
<script src="notificationSystem.js"></script>
    <script>
        const token = localStorage.getItem('token');
        const clubId = localStorage.getItem('userId');
        if (!token || !clubId || localStorage.getItem('role') !== 'club') {
            window.location.href = "login.html";
        }
        
        const headers = { 'Authorization': `Bearer ${token}` };
        const jsonHeaders = { ...headers, 'Content-Type': 'application/json' };

        function toggleMeetingLink() { document.getElementById('meetingLink-group').style.display = document.getElementById('eventMode').value === 'Online' ? 'block' : 'none'; }
        
        async function viewAttendees(eventId, eventTitle) {
            const modalTitle = document.getElementById('modal-event-title');
            const attendeeList = document.getElementById('attendees-list');
            modalTitle.innerText = eventTitle;
            attendeeList.innerHTML = '<div class="text-center py-4"><div class="animate-spin rounded-full h-8 w-8 border-b-2 border-primary mx-auto"></div></div>';
            try {
                const res = await fetch(`${BASE_URL}/api/events`, { headers });
                const events = await res.json();
                const event = events.find(e => e._id === eventId);
                if (!event || !event.attendees || event.attendees.length === 0) {
                    attendeeList.innerHTML = '<p class="text-gray-600">No attendees have registered yet.</p>';
                } else {
                    attendeeList.innerHTML = `<ul class="divide-y divide-gray-200">${event.attendees.map(a => `
                        <li class="flex items-center justify-between py-3">
                            <div>${a.userId?.name || 'N/A'} <br><small class="text-gray-500">${a.userId?.email || 'N/A'}</small></div>
                            ${a.isAttended ? '<span class="px-2 py-1 rounded-lg text-xs bg-green-100 text-green-700">Attended</span>' : `<button class="px-3 py-1 rounded-lg border border-green-600 text-green-700 hover:bg-green-50" onclick=\"markAttended('${eventId}','${a.userId?._id}')\">Mark Attended</button>`}
                        </li>`).join('')}</ul>`;
                }
                document.getElementById('attendanceModal').classList.remove('hidden');
            } catch (error) {
                attendeeList.innerHTML = '<p class="text-red-600">Failed to load attendees.</p>';
            }
        }

        async function markAttended(eventId, studentId) {
            try {
                const res = await fetch(`${BASE_URL}/api/events/${eventId}/manual-attendance`, {
                    method: 'POST', headers: jsonHeaders, body: JSON.stringify({ studentId })
                });
                if (!res.ok) throw new Error('Failed to mark attendance.');
                viewAttendees(eventId, document.getElementById('modal-event-title').innerText);
            } catch (error) {
                alert(error.message);
            }
        }

        function showQr(qrId) {
            const qrContainer = document.getElementById('qrcode');
            qrContainer.innerHTML = '';
            
            // Fix for Live Server and different deployment scenarios
            let fullUrl;
            const currentOrigin = window.location.origin;
            const currentPath = window.location.pathname;
            
            // Check if we're running on Live Server (port 5500) or similar dev server
            if (currentOrigin.includes('127.0.0.1:5500') || currentOrigin.includes('localhost:5500')) {
                // For Live Server, try different path combinations
                if (currentPath.includes('/frontend/')) {
                    // If we're already in /frontend/, use relative path
                    fullUrl = `${currentOrigin}/qr-attendance.html?qrId=${qrId}`;
                } else {
                    // If we're at root level, try both paths
                    fullUrl = `${currentOrigin}/qr-attendance.html?qrId=${qrId}`;
                }
            } else if (currentPath.includes('/frontend/')) {
                // For production with /frontend/ path
                fullUrl = `${currentOrigin}/frontend/qr-attendance.html?qrId=${qrId}`;
            } else {
                // Default case
                fullUrl = `${currentOrigin}/qr-attendance.html?qrId=${qrId}`;
            }
            
            // Add debugging information
            console.log('QR Code URL:', fullUrl);
            console.log('Current origin:', currentOrigin);
            console.log('Current path:', currentPath);
            console.log('Live Server detected:', currentOrigin.includes('127.0.0.1:5500') || currentOrigin.includes('localhost:5500'));
            console.log('Path contains /frontend/:', currentPath.includes('/frontend/'));
            
            new QRCode(qrContainer, { text: fullUrl, width: 256, height: 256 });
            document.getElementById('qrCodeModal').classList.remove('hidden');
        }
        
        function renderEventCard(event) {
            if (!event || !event.title) return '';
            const statusColors = { pending: 'warning', approved: 'success', rejected: 'danger', cancelled: 'dark' };
            return `
                <div class="col-md-4 mb-4">
                    <div class="card h-100 shadow-sm">
                        <div class="card-body">
                            <h5 class="card-title">${event.title}</h5>
                            <p class="card-text"><small class="text-muted">${new Date(event.date).toLocaleDateString()}</small></p>
                            <span class="badge bg-${statusColors[event.status]} mb-2">${event.status}</span>
                            <p><strong>Registrations:</strong> ${(event.attendees || []).length} / ${event.registrationLimit || '∞'}</p>
                            ${event.status === 'approved' ? `
                            <div class="d-grid gap-2">
                                <button class="btn btn-info btn-sm" onclick="viewAttendees('${event._id}', \`${event.title}\`)">View Attendees</button>
                                <button class="btn btn-primary btn-sm" onclick="showQr('${event.qrCodeId}')">Get QR</button>
                            </div>` : ''}
                        </div>
                    </div>
                </div>`;
        }

        async function loadEvents() {
            const pendingContainer = document.getElementById("pending-events-container");
            const approvedContainer = document.getElementById("approved-events-container");
            const eventSelect = document.getElementById('event-select');
            
            pendingContainer.innerHTML = '<div class="text-center py-6"><div class="animate-spin rounded-full h-8 w-8 border-b-2 border-primary mx-auto"></div></div>';
            approvedContainer.innerHTML = '';

            try {
                const res = await fetch(`${BASE_URL}/api/events`, { headers });
                if (!res.ok) throw new Error(`Server error: ${res.status}`);
                const allEvents = await res.json();
                const myEvents = allEvents
                    .filter(e => e.createdBy?._id === clubId)
                    .sort((a, b) => new Date(b.createdAt) - new Date(a.createdAt));

                // Populate certificate dropdown
                eventSelect.innerHTML = '<option value="">Select an event</option>';
                myEvents.filter(e => e.status === 'approved').forEach(event => {
                    const option = document.createElement('option');
                    option.value = event._id;
                    option.textContent = event.title;
                    if (event.certificateTemplateUrl) option.textContent += ' ✔️ Template Uploaded';
                    eventSelect.appendChild(option);
                });

                // Separate pending events
                const pendingEvents = myEvents.filter(e => e.status === 'pending' || e.status === 'rejected');
                if (pendingEvents.length > 0) {
                     pendingContainer.innerHTML = '<h4 class="text-xl font-bold mb-2">Pending & Rejected Events</h4><div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-6">' + pendingEvents.map(renderEventCard).join('') + '</div>';
                } else {
                    pendingContainer.innerHTML = '';
                }

                // Group approved events by category
                const approvedEvents = myEvents.filter(e => e.status === 'approved' || e.status === 'cancelled');
                const groupedEvents = approvedEvents.reduce((acc, event) => {
                    (acc[event.type] = acc[event.type] || []).push(event);
                    return acc;
                }, {});

                let approvedHtml = '<h4 class="text-xl font-bold mb-2">Approved & Cancelled Events</h4>';
                if (Object.keys(groupedEvents).length === 0) {
                    approvedHtml += '<p class="text-muted">No approved events yet.</p>';
                } else {
                    for (const type in groupedEvents) {
                        approvedHtml += `<h5 class="mt-3 text-muted">${type}</h5>`;
                        approvedHtml += '<div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-6">' + groupedEvents[type].map(renderEventCard).join('') + '</div>';
                    }
                }
                approvedContainer.innerHTML = approvedHtml;
                
            } catch (error) {
                approvedContainer.innerHTML = `<div class="alert alert-danger">${error.message}</div>`;
            }
        }

        document.getElementById('event-form').addEventListener('submit', async function(e) {
            e.preventDefault();
            const formData = new FormData(e.target);
            const msg = document.getElementById('proposal-msg');
            const submitBtn = e.target.querySelector('button[type="submit"]');
            msg.style.display = 'none';
            submitBtn.disabled = true;
            submitBtn.innerText = 'Submitting...';

            const question = formData.get('question')?.trim();
            if (question) {
                const options = [
                    formData.get('option1')?.trim(),
                    formData.get('option2')?.trim(),
                    formData.get('option3')?.trim(),
                    formData.get('option4')?.trim()
                ].filter(Boolean);
                const correctAnswer = formData.get('correctAnswer')?.trim();
                if (options.length < 2 || !correctAnswer || !options.includes(correctAnswer)) {
                    msg.className = 'text-danger';
                    msg.innerText = 'If providing a question, you must include at least two options and a correct answer.';
                    msg.style.display = 'block';
                    submitBtn.disabled = false;
                    submitBtn.innerText = 'Submit for Approval';
                    return;
                }
                const attendanceQuestion = { question, options, correctAnswer };
                formData.append('attendanceQuestion', JSON.stringify(attendanceQuestion));
            }

            try {
                const res = await fetch(`${BASE_URL}/api/events/create`, { method: 'POST', headers, body: formData });
                const result = await res.json();
                if (!res.ok) throw new Error(result.error || 'Failed to create event.');
                msg.className = 'text-green-600';
                msg.innerText = 'Event submitted for approval!';
                e.target.reset();
                loadEvents();
            } catch (error) {
                msg.className = 'text-red-600';
                msg.innerText = error.message;
            } finally {
                msg.style.display = 'block';
                submitBtn.disabled = false;
                submitBtn.innerText = 'Submit for Approval';
            }
        });

        document.getElementById('certificate-upload-form').addEventListener('submit', async function(e) {
            e.preventDefault();
            const eventId = document.getElementById('event-select').value;
            const fileInput = document.getElementById('certificate-file');
            const msgEl = document.getElementById('cert-upload-msg');
            const submitBtn = e.target.querySelector('button[type="submit"]');
            msgEl.style.display = 'none';
            submitBtn.disabled = true;
            submitBtn.innerText = 'Uploading...';
            if (!eventId || fileInput.files.length === 0) {
                msgEl.className = 'text-danger';
                msgEl.innerText = 'Please select an event and a PDF file.';
                msgEl.style.display = 'block';
                submitBtn.disabled = false;
                submitBtn.innerText = 'Upload Template';
                return;
            }
            const formData = new FormData();
            formData.append('certificate', fileInput.files[0]);
            try {
                const res = await fetch(`${BASE_URL}/api/events/${eventId}/upload-certificate-template`, { method: 'POST', headers, body: formData });
                const result = await res.json();
                if (!res.ok) throw new Error(result.error || 'Upload failed');
                msgEl.className = 'text-green-600';
                msgEl.innerText = '✅ Template uploaded successfully!';
                loadEvents();
            } catch (error) {
                msgEl.className = 'text-red-600';
                msgEl.innerText = `❌ Error: ${error.message}`;
            } finally {
                msgEl.style.display = 'block';
                submitBtn.disabled = false;
                submitBtn.innerText = 'Upload Template';
            }
        });
        
        document.addEventListener('DOMContentLoaded', loadEvents);
    </script>
    <script src="navbar.js"></script>
    <script src="footer.js"></script>
</body>
</html>